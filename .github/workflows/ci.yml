name: CI

# Controls when the action will run.
# For various `on` trigger possibilities, see:
# https://docs.github.com/en/actions/using-workflows/triggering-workflows

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This job builds the code, runs tests, and verifies linting
  build_and_test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository into the working environment
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Linter and Formatter (Biome)
        run: npx @biomejs/biome check --apply src/

      - name: Run Unit Tests (Vitest)
        run: npx vitest run --coverage

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          dir: ./coverage
          fail_ci_if_error: true

      - name: Build Project (Vite)
        run: npm run build -- --mode production
        env:
          VITE_API_URL: ${{ secrets.PROD_API_URL }}

      # Add E2E tests here if applicable (e.g., Playwright)
      # - name: Run E2E Tests (Playwright)
      #   run: npx playwright install && npx playwright test

  # This job is for deployment to production (requires manual trigger or specific branch push)
  deploy:
    needs: build_and_test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # Only run on push to main
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project for Production
        run: npm run build -- --mode production
        env:
          VITE_API_URL: ${{ secrets.PROD_API_URL }}

      - name: Deploy to Production (Example: App Store Connect/Google Play)
        # This is a placeholder for actual deployment logic.
        # For React Native/Expo apps, this typically involves EAS Build and Submit.
        # Consult EAS CLI documentation for detailed integration:
        # https://docs.expo.dev/submit/github-actions/
        run: |
          echo "Deploying to production..."
          # Example using EAS CLI (requires setup and secrets):
          # npx eas-cli login --token ${{ secrets.EAS_USER_ACCESS_TOKEN }}
          # npx eas-cli build --platform all --profile production --auto-submit
          echo "Placeholder for actual deployment commands."
        env:
          # Ensure you have the necessary secrets configured in GitHub Actions secrets
          EAS_USER_ACCESS_TOKEN: ${{ secrets.EAS_USER_ACCESS_TOKEN }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY_PATH: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY_PATH }}
          GOOGLE_PLAY_SERVICE_ACCOUNT_KEY_PATH: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY_PATH }}
